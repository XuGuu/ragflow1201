# 权限与身份详解

本文用更细的中文说明，帮助你理解 RAGFlow 如何建模用户、团队（Tenant）以及资源权限，并在阅读代码或排查问题时快速定位入口。

## 核心身份与角色
- **User（用户账号）**：保存登录凭据及标志位，例如：
  - `is_superuser`：全局管理员，可跨租户查看与操作所有资源。
  - `status`：启用/禁用状态，被禁用的用户无法登录或发起操作。
- **Tenant（租户/团队）**：逻辑工作区，绑定默认模型与工具配置（LLM、向量模型、解析器等），团队成员共享这些默认项。
- **UserTenant（成员关系）**：用户在某个租户下的角色：
  - `owner`：创建者与最终责任人，可管理成员、资源和默认配置。
  - `admin`：团队管理员，通常能创建/管理资源，但不可删除 Owner。
  - `normal`：普通成员，仅能访问被允许的团队资源。
  - `invite`：待接受的邀请记录，尚无实际访问权。

## 资源与权限标记
当前主要面向知识库与文件：
- **TenantPermission 枚举**：
  - `me`：仅创建者本人或资源所属租户可见。
  - `team`：同一租户的所有成员可见。
- **存储位置**：知识库/文件记录上的 `permission` 字段，决定资源能否被团队内的其他人访问。
- **常见资源与归属**：
  - 知识库（datasets）与其中的文档（files）挂在所属租户上。
  - 画布、聊天会话等业务实体通常也会记录所属租户，用同样的校验方式过滤。

## 访问校验的基本流程
以下流程贯穿查询列表、获取详情、上传/写入等场景：
1. **获取调用者所属租户**：根据用户 ID 查询 `UserTenant` 表，得到可用的租户列表与角色。
2. **比对资源归属**：读取资源记录中的租户 ID 和 `permission`：
   - 若资源标记为 `me`，仅当调用者属于同一租户（或是创建者/超级用户）才允许访问。
   - 若资源标记为 `team`，在同租户且非 `invite` 状态的成员即可访问。
3. **使用辅助函数做统一校验**：
   - `api/common/check_team_permission.py` 提供 `check_kb_team_permission`、`check_file_team_permission` 等函数，封装“用户租户集合 ∩ 资源租户”与权限标记的判断逻辑。
4. **超级用户旁路**：`is_superuser` 用户无需匹配租户与权限标记，可直接操作，用于运维和修复。

## 代码落点速览
- **模型定义**：`api/db/db_models.py` 描述了 User、Tenant、UserTenant 以及 `TenantPermission` 枚举；`api/db/__init__.py` 初始化数据库访问。
- **权限检查**：`api/common/check_team_permission.py` 集中实现知识库、文件的团队校验函数，并被各业务服务调用。
- **业务调用示例**：
  - `api/apps/kb_app.py`：列出/读取知识库时会调用团队校验，确保仅团队成员可见。
  - `api/apps/document_app.py`：上传、获取文件前，同样会基于租户与 `TenantPermission` 过滤。
- **管理工具**：默认超级用户（`admin@ragflow.io / admin`）可通过 Admin Service/CLI 管理用户与服务，绕开常规限制用于恢复或排障。

## 场景化示例
- **团队共享**：成员 A 创建知识库并设置 `permission=team`，同一租户内的 B、C 能直接查看并导入文档；若设置为 `me`，仅 A 及超级用户可见。
- **邀请流程**：当用户在某租户的 `UserTenant.role=invite` 时，尚未获得实际访问权；接受邀请后角色变为 `normal/admin/owner`，才会通过校验。
- **被禁用账号**：`status` 被禁用的用户即便关系存在，也无法登录和访问，常用于紧急冻结。

## 学习与排查建议
1. **从表结构入手**：先读 `api/db/db_models.py`，确认字段和枚举含义，再在数据库或日志中对应观察。
2. **跟踪一次请求**：在 `api/apps/kb_app.py` 或 `api/apps/document_app.py` 找到入口函数，追踪调用的权限检查流程（搜索 `check_*_permission`）。
3. **验证角色差异**：使用 Admin CLI 创建不同角色成员，在同一租户尝试访问 `me` 与 `team` 资源，观察期望行为。
4. **利用超级用户恢复**：若权限配置异常，可用超级账号清理或重建用户/租户关系，确保资源归属与成员关系一致。
