# 权限与身份概览

本文概述 RAGFlow 如何建模用户、租户（团队）以及资源权限，帮助新人在阅读代码前先建立概念图。

## 用户身份
- **User**：保存账号信息及标志位，如 `is_superuser`（全局管理员）和 `status`（启用状态）。超级用户可通过管理工具操作所有租户与数据。
- **Tenant**：团队/工作区容器，默认模型配置（LLM、向量模型、解析器等）挂载在租户记录上。
- **User-Tenant 关系**：`UserTenant` 表使用 `role` 字段描述成员角色：
  - `owner`：租户创建者，拥有完全控制权，可邀请/移除成员并提升角色。
  - `admin`：管理角色（具体能力见各 API 服务业务逻辑），权限高于普通成员。
  - `normal`：普通成员，具备常规资源访问权限。
  - `invite`：尚未接受的邀请记录。

## 资源共享权限
- **知识库与文件** 使用 `TenantPermission` 枚举标记 `permission`：
  - `me`：仅创建者/所属租户可见。
  - `team`：同租户团队共享。
- **团队校验** 通过辅助逻辑实现：
  - 请求用户与资源租户一致或资源归属用户即视为可访问。
  - 对 `team` 资源，会解析已加入的租户成员关系以验证访问（参见 `check_kb_team_permission`、`check_file_team_permission`）。

## 权限生效位置
- 服务层查询在列出或获取画布、知识库、文档、聊天时，会按租户成员关系与 `TenantPermission` 过滤。
- 用户操作（如上传文档、查询数据集、使用画布）通常会获取调用者的租户列表并与资源所属租户取交集，再决定可见性。
- 超级用户流程通过 Admin Service/CLI 绕过这些限制。

## 管理与生命周期
- 默认超级用户（`admin@ragflow.io` / `admin`）可通过 Admin Service 与 CLI 管理服务和用户。
- CLI 命令支持创建/删除用户、切换启用状态、按用户列出数据集/代理、检查服务健康，便于从错误配置中恢复。
- 删除用户会级联清理其拥有的租户、连接器及相关记录，保持租户与资源映射一致。

## 学习路径建议
1. **先看表结构**：从 `api/db/db_models.py` 和 `api/db/__init__.py` 了解用户/租户/权限枚举定义。
2. **查看校验点**：阅读 `api/common/check_team_permission.py` 以及知识库、画布等服务类的逻辑，确认租户过滤的应用方式。
3. **跟踪请求链**：在 `api/apps/*`（如 `kb_app.py`、`document_app.py`）中追踪如何获取租户列表并在读写时校验权限。
4. **熟悉管理工具**：参考 `docs/guides/manage_users_and_services.md` 使用 Admin CLI，结合角色/权限变更做端到端验证。
